<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>卷2 出餐紀錄 + 成分筆記</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --text:#202124; --muted:#666;
      --border:#e6e6ef; --primary:#2b7cff; --success:#129c6e;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;
      font-size:clamp(16px, 2.2vw + 10px, 18px); line-height:1.6;
      -webkit-text-size-adjust:100%;
    }
    header{padding:18px 16px 8px}
    h1{margin:0;font-size:clamp(20px,3.4vw + 10px,28px);letter-spacing:.3px}
    .sub{color:var(--muted);margin-top:6px}
    .wrap{max-width:980px;margin:0 auto;padding:10px 16px 28px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .toolbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 14px;border-bottom:1px solid var(--border);flex-wrap:wrap
    }
    .pill{font-size:.92em;color:var(--muted)}
    .btn{
      border:1px solid var(--border);background:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;
      min-height:44px; min-width:44px; touch-action:manipulation;
    }
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:600px}
    th,td{padding:14px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{font-size:.9em;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);background:#fafafe}
    .name{font-weight:800}
    .name .tap{color:#0b6bcb;text-decoration:underline dotted 1px;cursor:pointer}
    .note{color:var(--muted);font-size:.92em;margin-top:2px}
    .count{font-variant-numeric:tabular-nums}
    .ing-cell{background:#fff}
    .ing-list{margin:6px 0 0 0;padding-left:20px}
    .ing-list li{margin:4px 0}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.9em;border:1px solid var(--border);color:var(--muted)}
    .footer{padding:12px 14px;color:var(--muted);font-size:.9em}
    @media (max-width:720px){
      th:nth-child(2), td:nth-child(2){display:none;} /* 手機隱藏每日目標欄位 */
      .toolbar{gap:10px}
      .btn{padding:12px 14px}
    }
    @media (pointer:coarse){
      th,td{padding:16px 14px}
    }
  </style>
</head>
<body>
  <header>
    <h1>卷2 出餐紀錄 + 成分筆記</h1>
    <!-- <div class="sub">點「出餐 1 份」→ 剩餘 −1；剩餘為 0 會自動隱藏該產品。點產品名稱可在下一列展開/收合成分。</div> -->
  </header>

  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <div class="pill">
          總剩餘：<strong class="count" id="total-remaining">0</strong> 份
          <span class="badge" id="done-badge" style="display:none;margin-left:8px;">全部出餐完成 ✅</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="reset-btn" title="恢復每日目標">全部重設</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="list">
          <thead>
            <tr>
              <th style="width:46%;">產品</th>
              <th style="width:16%;">每日目標</th>
              <th style="width:16%;">剩餘</th>
              <th style="width:22%;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- <div class="footer">資料保存在此裝置的瀏覽器（localStorage）。同名品項自動標註「批次」以利區分。</div> -->
    </div>
  </div>

  <script>
    // 成分庫
    const INGREDIENTS = {
      "加州卷": ["2號反卷","白芝麻、橙魚子","蟹肉碎 60g、青瓜 10g、牛油果 15g"],
      "加州卷-綠草": ["2號反卷 / 綠草版","※（待補）"],
      "白加州": ["2號反卷","蟹肉碎 60g、青瓜 25g"],
      "三文小卷": ["1號正卷","三文魚 30g"],
      "海鮮": ["2號反卷 / 雜錦組合","白芝麻、橙魚子","青瓜 10g、蟹肉碎 20g、三文魚 15g、玉子蛋 10g"]
    };

    // 最新清單（你最後確認）
    const initialItems = [
      { name: "白加州",   target: 9,  note: "没魚子 5、橙魚子 4", ingKey: "白加州" },
      { name: "加州卷",   target: 20, note: "綠草 4、橙魚子 16",  ingKey: "加州卷" },
      { name: "三文小卷", target: 12, note: "",                   ingKey: "三文小卷" },
      { name: "加州卷",   target: 10, note: "",                   ingKey: "加州卷" },
      { name: "海鮮",     target: 5,  note: "",                   ingKey: "海鮮" },
      { name: "加州卷",   target: 15, note: "",                   ingKey: "加州卷" },
      { name: "三文小卷", target: 10, note: "",                   ingKey: "三文小卷" }
    ].map((it, i) => ({ id:String(i+1), remaining:it.target, ...it }));

    const STORAGE_KEY = "juan2-orders-with-ingredients-v3-mobile";
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return initialItems;
      try{
        const parsed = JSON.parse(raw);
        return initialItems.map(it=>{
          const f = parsed.find(p=>p.id===it.id);
          return f ? {...it, remaining:Math.max(0, f.remaining)} : it;
        });
      }catch{ return initialItems; }
    }
    function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

    let state = loadState();
    const tbody = document.getElementById("tbody");
    const totalRemainingEl = document.getElementById("total-remaining");
    const doneBadge = document.getElementById("done-badge");

    function displayLabel(item, idxForName){
      return idxForName > 1 ? `${item.name}（批次${idxForName}）` : item.name;
    }
    function renderIngredients(key){
      const lines = INGREDIENTS[key] || ["（成分待補）"];
      return `<ul class="ing-list">${lines.map(t=>`<li>${t}</li>`).join("")}</ul>`;
    }

    function removeIngredientRowIfAny(tr){
      const next = tr.nextElementSibling;
      if(next && next.dataset && next.dataset.role === "ing") next.remove();
    }

    function insertIngredientRowAfter(tr, item){
      // 若已展開，則收合
      const next = tr.nextElementSibling;
      if(next && next.dataset && next.dataset.role === "ing"){ next.remove(); return; }
      // 插入新列
      const ingTr = document.createElement("tr");
      ingTr.dataset.role = "ing";
      // 目前表格 4 欄
      ingTr.innerHTML = `<td class="ing-cell" colspan="4">${renderIngredients(item.ingKey)}</td>`;
      tr.parentNode.insertBefore(ingTr, tr.nextElementSibling);
    }

    function render(){
      tbody.innerHTML = "";
      const nameCounter = {};
      let totalRemaining = 0;

      for(const item of state){
        if(item.remaining <= 0) continue; // 直接隱藏

        nameCounter[item.name]=(nameCounter[item.name]||0)+1;
        const idxForName = nameCounter[item.name];

        const tr = document.createElement("tr");
        tr.dataset.id = item.id;
        tr.innerHTML = `
          <td class="name">
            <span class="tap" id="tap-${item.id}" title="點擊展開/收合成分">${displayLabel(item, idxForName)}</span>
            ${item.note ? `<div class="note">備註：${item.note}</div>` : ""}
          </td>
          <td class="count">${item.target}</td>
          <td class="count" id="remain-${item.id}">${item.remaining}</td>
          <td>
            <button class="btn primary" id="btn-${item.id}" aria-label="為『${item.name}』出餐 1 份">出餐 1 份</button>
          </td>
        `;
        tbody.appendChild(tr);

        // 點名稱展開/收合成分
        tr.querySelector(`#tap-${item.id}`).addEventListener("click", ()=>{
          insertIngredientRowAfter(tr, item);
        });

        // 出餐按鈕
        const btn = tr.querySelector(`#btn-${item.id}`);
        btn.addEventListener("click", ()=>{
          if(item.remaining>0){
            item.remaining -= 1;
            document.getElementById(`remain-${item.id}`).textContent = item.remaining;
            saveState(state);
            if(item.remaining<=0){
              // 收合並移除本列（含成分列）
              removeIngredientRowIfAny(tr);
              tr.remove();
            }
            updateTotals();
          }
        });

        totalRemaining += Math.max(0, item.remaining);
      }

      totalRemainingEl.textContent = totalRemaining;
      doneBadge.style.display = totalRemaining===0 ? "inline-block" : "none";
    }

    function updateTotals(){
      const total = state.reduce((s,it)=>s+Math.max(0,it.remaining),0);
      totalRemainingEl.textContent = total;
      doneBadge.style.display = total===0 ? "inline-block" : "none";
    }

    // 重設
    document.getElementById("reset-btn").addEventListener("click", ()=>{
      if(confirm("確認恢復所有剩餘至每日目標？")){
        state = state.map(it=>({...it, remaining:it.target}));
        saveState(state); render(); updateTotals();
      }
    });

    render();
  </script>
</body>
</html>
